<html>

<head>
    <style>
        .Hili {
            background-color: red;
        }

        input, td[contenteditable] {
            background-color: lightgoldenrodyellow;
        }

        #table_holder {
            overflow-y: scroll;
            display: block;
            background-color: antiquewhite;
            height: 100px;
        }
        .mystorage{
            float: right;
        }
    </style>
    <script src="./js/chart.js" xxsrc="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        var labels = [
            'January',
            'February',
        ];
        labels = []
        for (var yr = 1964; yr <= 2025; yr++) {
            labels.push("" + yr)
        }

        var my_test_ary = [{ x: 1964, y: -100 }, { x: 1964, y: 100 }, { x: 1964, y: 0 }, { x: 1967, y: -50 }]
        my_test_ary = [{ x: "1964", y: -100 }, { x: "1964", y: 100 }, { x: "1964", y: 0 }, { x: "2025", y: 0 }]

        var data = {
            labels: labels,
            datasets: [
                {
                    label: 'My Spiritual Journey So Far',
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    //data: [-50, 10, 5, 2, 20, 30, 45],
                    data: null
                },
                {
                    label: 'Middle-line',
                    backgroundColor: 'rgb(15, 99, 132)',
                    borderColor: 'rgb(100, 99, 132)',
                    //data: [-50, 10, 5, 2, 20, 30, 45],
                    data: my_test_ary
                },
            ]
        };

        var config = {
            type: 'line',
            data: data,
            options: {}
        };
    </script>

    <script>
        function gen_table_new() {
            var yrs = document.getElementById("StartYear").value
            var sofar = 3 + parseInt((new Date).getFullYear())
            var obj = {}
            for (var yr = parseInt(yrs); yr <= sofar; yr++) {
                obj["" + yr] = ["", ""]
            }
            gen_tbody_by_obj(obj)
        }
        function gen_tbody_by_obj(obj) {
            var trs = "", idx = 0
            Object.keys(obj).forEach(function (yr, i) {
                var lev = obj[yr][0], des = obj[yr][1]
                var dlev = lev.length === 0 ? -100 : lev
                trs += `<tr><td>${i++}</td><td onclick="toggleNextVisibility(this);">${yr}</td><td><input oninput="on_level_input(this);" onchange="on_level_Change(this);" class="level" style="visibility:visible;" type="range" min="-100" max="100" value="${dlev}"></input></td><td>${lev}</td><td contenteditable='true'>${des}</td></tr>`
            })
            document.getElementById('tbid').innerHTML = trs;
        }
        function obj_to_chart_data(obj) {
            var ary = []
            Object.keys(obj).forEach(function (yr, i) {
                var lev = obj[yr][0], des = obj[yr][1]
                if (lev) {
                    var pobj = { x: (yr), y: parseInt(lev) }
                    ary.push(pobj)
                }

            })
            //data.datasets.data = ary
            return ary;
        }


        function on_level_input(evt) {
            var val = evt.value
            console.log(val)
            if (parseInt(val) <= -100) val = ''
            evt.parentElement.nextSibling.innerHTML = val
        }
        function on_level_Change(evt) {
            //update graphic
            var obj = get_data_fr_table()
            //localStorage.setItem("tbid", JSON.stringify(obj))
            //document.getElementById("tout").value = JSON.stringify(obj, null, 4)
            var dat = obj_to_chart_data(obj)
            update_chart(dat)
        }
        function toggleNextVisibility(evt) {
            var val = evt.nextSibling.firstChild.style.visibility === "hidden" ? "visible" : "hidden"
            evt.nextSibling.firstChild.style.visibility = val
            var elms = document.getElementsByClassName("Hili")
            for (var i = 0; i < elms.length; i++) {
                elms[i].classList.remove("Hili")
            };
            evt.classList.add("Hili");
        }
        function storage_save() {
            var str = document.getElementById("tbid").innerHTML.trim()
            if (!str) return alert("nothing to save")
            else if (!confirm("Save to local storage.\nSure?")) return
            var obj = get_data_fr_table()
            localStorage.setItem("tbid", JSON.stringify(obj))
            document.getElementById("tout").value = JSON.stringify(obj, null, 4)
            var dat = obj_to_chart_data(obj)
            update_chart(dat)
        }
        function storage_load() {
            var str = localStorage.getItem("tbid")
            if (!str) return
            var obj = JSON.parse(str)
            document.getElementById("tout").value = JSON.stringify(obj, null, 4)
            gen_tbody_by_obj(obj)
            var dat = obj_to_chart_data(obj)
            update_chart(dat)
        }
        function get_data_fr_table() {
            var ar = document.getElementsByTagName("tr")
            var obj = {}
            for (var i = 1; i < ar.length; i++) {
                var etds = ar[i].children
                var yrs = etds[1].textContent
                var lev = etds[3].textContent
                var txt = etds[4].textContent
                obj[yrs] = [lev, txt]
            }
            return obj;
        }
        function update_chart(dat) {
            // JS - Destroy exiting Chart Instance to reuse <canvas> element
            let chartStatus = Chart.getChart("myChart"); // <canvas> id
            if (chartStatus != undefined) {
                chartStatus.destroy();
            }

            console.log(dat)
            config.data.datasets[0].data = dat
            const myChart = new Chart(
                document.getElementById('myChart'),
                config
            );
            //myChart.destroy();

        }
        function read_data() {
            var str = document.getElementById("tout").value
            if(str.trim().length===0) return alert("no data to read. Please paste your data here.")
            try{
            var obj = JSON.parse(str);
            var dat = obj_to_chart_data(obj)
            gen_tbody_by_obj(obj)
            update_chart(dat)
            }catch{
                alert("json data error.")
            }
        }

    </script>

</head>


<body>
    <div>
        <canvas id="myChart"></canvas>
    </div>
   
    <div id="table_holder">
        <table border="1">
            <thead>
                <tr>
                    <th>Age</th>
                    <th>Year</th>
                    <th colspan="2">Level</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody id="tbid">

            </tbody>
        </table>
    </div>

    <a>Year Start:</a> <input id="StartYear" value="1964"></input><button
    onclick="gen_table_new();">New</button></button>
   
    <textarea class="mystorage"  id="tout"></textarea>
    <button class="mystorage"  onclick="read_data();">Read</button>
    <button class="mystorage" onclick="storage_load();">Load</button>
    <button class="mystorage" onclick="storage_save();">Save</button>

</body>

</html>

<script>


    update_chart(my_test_ary)
    update_chart(my_test_ary)

</script>